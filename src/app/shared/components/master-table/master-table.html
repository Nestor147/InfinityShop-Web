<!-- Show messages when there's no data -->
<div *ngIf="tableData.length === 0 && backendMessages.length > 0" class="p-4 space-y-3">
  <div *ngFor="let message of backendMessages"
       [ngClass]="getMessageClasses(message.type)"
       class="border rounded-lg p-4">
    <p class="text-sm font-medium">{{ message.description }}</p>
  </div>
</div>

<!-- Show table when there's data -->
<div *ngIf="tableData.length > 0" class="w-full">
  <!-- Table Container -->
  <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
    <table class="min-w-full divide-y divide-gray-200">
      <!-- Header -->
      <thead class="bg-sa-primary">
        <tr>
          <th *ngFor="let col of displayedColumns; let i = index; trackBy: trackByCol"
              class="px-6 py-3 text-left text-xs font-medium text-stone-50 uppercase tracking-wider select-none"
              [class.cursor-pointer]="!(i === 0 || i === displayedColumns.length - 1 || imageColumns.includes(col))"
              [class.hover:bg-gray-100]="!(i === 0 || i === displayedColumns.length - 1 || imageColumns.includes(col))"
              [class.hover:text-gray-800]="!(i === 0 || i === displayedColumns.length - 1 || imageColumns.includes(col))"
              (click)="!(i === 0 || i === displayedColumns.length - 1 || imageColumns.includes(col)) && sortBy(col)">
            <div class="flex items-center space-x-1">
              <span>{{ col }}</span>
              <ng-container *ngIf="!(i === 0 || i === displayedColumns.length - 1 || imageColumns.includes(col))">
                <span class="text-sm transition-colors duration-200"
                      [class.text-white]="!sortColumn || sortColumn !== col"
                      [class.text-white]="sortColumn === col && sortDirection">
                  <ng-container *ngIf="sortColumn === col">
                    <span *ngIf="sortDirection === 'asc'">↑</span>
                    <span *ngIf="sortDirection === 'desc'">↓</span>
                  </ng-container>
                  <span *ngIf="sortColumn !== col">↕</span>
                </span>
              </ng-container>
            </div>
          </th>
        </tr>
      </thead>

      <!-- Body -->
      <tbody class="bg-white divide-y divide-gray-200">
        <tr *ngFor="let row of tableData; let rowIndex = index"
            class="hover:bg-gray-50 transition-colors duration-150">
          <td *ngFor="let col of displayedColumns; trackBy: trackByCol"
              class="px-6 py-4 text-sm text-gray-900">

            <!-- Action Cell -->
            <ng-container *ngIf="row['_' + col] as actions; else showPlain">
              <ng-container *ngIf="hasActions(actions); else showPlain">
                <div class="flex items-center gap-2">
                  <ng-container *ngFor="let a of row['__ui_' + col]; trackBy: trackByAction">
                    <button
                      type="button"
                      [ngClass]="getSeverityClasses(a.severity)"
                      class="rounded-full p-2 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow"
                      [title]="a.label"
                      [attr.aria-label]="a.label"
                      (click)="onActionClick(a, $event)">
                      <span class="text-base leading-none">{{ a.icon }}</span>
                    </button>
                  </ng-container>
                </div>
              </ng-container>
            </ng-container>

            <!-- Normal Cell -->
            <ng-template #showPlain>
              <ng-container *ngIf="isImage(row[col]); else plainText">
                <img
                  [src]="row[col]"
                  alt="image"
                  class="h-12 w-12 object-cover rounded cursor-zoom-in hover:opacity-80 transition-opacity duration-200"
                  (click)="openImage(row[col])"
                />
              </ng-container>
              <ng-template #plainText>
                <!-- Check if has editColumn action -->
                <ng-container *ngIf="hasEditColumnAction(row['_' + col]); else onlyText">
                  <!-- Edit Mode -->
                  <div *ngIf="isCellInEdit(rowIndex, col)" class="space-y-2">
                    <div class="flex items-center gap-2">
                      <input
                        type="text"
                        [(ngModel)]="editingValue"
                        class="flex-1 px-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow disabled:bg-gray-100 disabled:cursor-not-allowed"
                        [class.border-red-500]="validationError"
                        [class.border-gray-300]="!validationError"
                        [disabled]="saving"
                        (keydown.enter)="confirmEdit()"
                        (keydown.escape)="cancelEdit()"
                        placeholder="Enter value"
                      />
                      <button
                        type="button"
                        class="flex-shrink-0 rounded-full p-2 bg-green-500 hover:bg-green-600 text-white transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm"
                        [disabled]="saving"
                        (click)="confirmEdit()"
                        title="Save"
                        aria-label="Save">
                        <span class="text-base leading-none">✓</span>
                      </button>
                      <button
                        type="button"
                        class="flex-shrink-0 rounded-full p-2 bg-red-500 hover:bg-red-600 text-white transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm"
                        [disabled]="saving"
                        (click)="cancelEdit()"
                        title="Cancel"
                        aria-label="Cancel">
                        <span class="text-base leading-none">✕</span>
                      </button>
                    </div>
                    <small *ngIf="validationError" class="block text-red-600 text-xs mt-1">{{ validationError }}</small>
                  </div>
                  <!-- View Mode with Edit Capability -->
                  <div *ngIf="!isCellInEdit(rowIndex, col)"
                       class="flex items-center justify-between group cursor-pointer hover:bg-gray-100 -mx-2 px-2 py-1 rounded transition-colors duration-150"
                       (click)="activateColumnEdit(rowIndex, col, getEditColumnAction(row['_' + col])!, row[col].toString())">
                    <span class="whitespace-nowrap">{{ row[col] }}</span>
                    <span class="text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity duration-150 ml-2 flex-shrink-0">⚙️</span>
                  </div>
                </ng-container>
                <ng-template #onlyText>
                  <span class="whitespace-nowrap">{{ row[col] }}</span>
                </ng-template>
              </ng-template>
            </ng-template>

          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="totalRecords > 0" class="mt-4 flex flex-col sm:flex-row items-center justify-between gap-4 px-4 py-3 bg-white border border-gray-200 rounded-lg shadow-sm">
    <!-- Page Size Selector -->
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-700 font-medium whitespace-nowrap">Rows per page:</label>
      <select
        [value]="rows"
        (change)="onPageSizeChange(+$any($event.target).value)"
        class="px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white cursor-pointer">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="50">50</option>
        <option [value]="100">100</option>
      </select>
    </div>

    <!-- Page Info -->
    <div class="text-sm text-gray-700 font-medium">
      Showing <span class="font-semibold text-gray-900">{{ showingFrom }}</span> to
      <span class="font-semibold text-gray-900">{{ showingTo }}</span> of
      <span class="font-semibold text-gray-900">{{ totalRecords }}</span> entries
    </div>

    <!-- Page Navigation -->
    <div class="flex items-center gap-1">
      <!-- Previous Button -->
      <button
        type="button"
        (click)="onPaginate(page - 1)"
        [disabled]="page === 0"
        class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed border border-gray-300"
        [class.bg-gray-100]="page === 0"
        [class.text-gray-400]="page === 0"
        [class.text-gray-700]="page !== 0"
        [class.hover:bg-gray-100]="page !== 0"
        [class.hover:border-gray-400]="page !== 0">
        Previous
      </button>

      <!-- Page Numbers -->
      <ng-container *ngFor="let pageNum of paginationArray">
        <button
          *ngIf="pageNum !== -1"
          type="button"
          (click)="onPaginate(pageNum)"
          class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors duration-150 border"
          [class.bg-sa-primary]="page === pageNum"
          [class.text-white]="page === pageNum"
          [class.border-blue-500]="page === pageNum"
          [class.hover:bg-blue-600]="page === pageNum"
          [class.bg-white]="page !== pageNum"
          [class.border-gray-300]="page !== pageNum"
          [class.hover:bg-gray-100]="page !== pageNum"
          [class.hover:border-gray-400]="page !== pageNum"
          [class.text-gray-700]="page !== pageNum">
          {{ pageNum + 1 }}
        </button>
        <span *ngIf="pageNum === -1" class="px-2 text-gray-400 select-none">...</span>
      </ng-container>

      <!-- Next Button -->
      <button
        type="button"
        (click)="onPaginate(page + 1)"
        [disabled]="page >= totalPages - 1"
        class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed border border-gray-300"
        [class.bg-gray-100]="page >= totalPages - 1"
        [class.text-gray-400]="page >= totalPages - 1"
        [class.text-gray-700]="page < totalPages - 1"
        [class.hover:bg-gray-100]="page < totalPages - 1"
        [class.hover:border-gray-400]="page < totalPages - 1">
        Next
      </button>
    </div>
  </div>
</div>

<!-- Image Dialog Modal -->
<div *ngIf="showImageDialog"
     class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 backdrop-blur-sm"
     (click)="closeImageDialog()">
  <div class="relative max-w-6xl max-h-[90vh] bg-white rounded-lg shadow-2xl p-4 animate-fade-in"
       (click)="$event.stopPropagation()">
    <button
      type="button"
      (click)="closeImageDialog()"
      class="absolute top-2 right-2 z-10 p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 shadow-md"
      aria-label="Close image">
      <span class="text-xl text-gray-600 leading-none">✕</span>
    </button>
    <img *ngIf="selectedImage"
         [src]="selectedImage"
         alt="large image"
         class="max-w-full max-h-[80vh] object-contain mx-auto rounded" />
  </div>
</div>
